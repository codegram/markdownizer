<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>markdownizer.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>markdownizer.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p> <strong>Markdownizer</strong> is a simple solution to a simple problem.</p>

<p> It is a lightweight Rails 3 gem which enhances any ActiveRecord model with a
 singleton <code>markdownize!</code> method, which makes any text attribute renderable as
 Markdown. It mixes CodeRay and RDiscount to give you awesome code
 highlighting, too!</p>

<p> If you have any suggestion regarding new features, Check out the <a href="http://github.com/codegram/markdownizer">Github repo</a>,
 fork it and submit a nice pull request :)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <h3>Install Markdownizer</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p> Get Markdownizer in your Rails 3 app through your Gemfile:</p>

<pre><code> gem 'markdownizer'
</code></pre>

<p> If you don&rsquo;t use Bundler, you can alternatively install Markdownizer with
 Rubygems:</p>

<pre><code> gem install markdownizer
</code></pre>

<p> If you want code highlighting, you should run this generator too:</p>

<pre><code> rails generate markdownizer:install
</code></pre>

<p> This will place a <code>markdownizer.css</code> file in your <code>public/stylesheets</code>
 folder. You will have to require it manually in your layouts, or through
 <code>jammit</code>, or whatever.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <h3>Usage</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> In your model, let&rsquo;s say, <code>Post</code>:</p>

<pre><code> class Post &lt; ActiveRecord::Base
   # In this case we want to treat :body as markdown
   # This will require `body` and `rendered_body` fields
   # to exist previously (otherwise it will raise an error).
   markdownize! :body
 end
</code></pre>

<p> Then you can create a <code>Post</code> using Markdown syntax, like this:</p>

<pre><code>Post.create body: """
   # My H1 title
   Markdown is awesome!
   ## Some H2 title...

   {% code ruby %}

     # All this code will be highlighted properly! :)
     def my_method(*my_args)
       something do
         3 + 4
       end
     end

   {% endcode %}
"""
</code></pre>

<p> After that, in your view you just have to call <code>@post.rendered_body</code> and,
 provided you included the generated css in your layout, it will display nice
 and coloured :)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <h3>Show me the code!</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> We&rsquo;ll need to include <a href="http://github.com/rtomayko/rdiscount">RDiscount</a>. This is the Markdown parsing library.
 Also, <a href="http://github.com/rubychan/coderay">CodeRay</a> will provide code highlighting. We require <code>active_record</code> as
 well, since we want to extend it with our DSL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rdiscount&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;coderay&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span> <span class="k">unless</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="p">)</span>

<span class="k">module</span> <span class="nn">Markdownizer</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> Here we define two helper methods. These will be called from the model to
 perform the corresponding conversions and parsings.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>   </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> <code>Markdownizer.markdown</code> method converts plain Markdown text to formatted html.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">markdown</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="no">RDiscount</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> <code>Markdownizer.coderay</code> method parses a code block delimited from <code>{% code
 ruby %}</code> until <code>{% endcode %}</code> and replaces it with appropriate classes for
 code highlighting. It can take many languages aside from Ruby.</p>

<p> It also parses the special idiom {% caption &lsquo;my caption&rsquo; %}, which both
 introduces an h5 before the code and passes the caption to the enclosing div
 as a parameter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">coderay</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="n">text</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r[\{% caption &#39;([\w\s]+)&#39; %\}]</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">options</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span><span class="ss">:caption</span> <span class="o">=&gt;</span> <span class="vg">$1</span><span class="p">})</span> <span class="k">if</span> <span class="vg">$1</span>
        <span class="s2">&quot;#####&quot;</span> <span class="o">&lt;&lt;</span> <span class="vg">$1</span>
      <span class="k">end</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r[\{% code (\w+?) %\}(.+?)\{% endcode %\}]m</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">CodeRay</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="vg">$2</span><span class="p">,</span> <span class="vg">$1</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">({</span><span class="ss">:css</span> <span class="o">=&gt;</span> <span class="ss">:class</span><span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <h3>Public interface</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  </pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> The Markdownizer DSL is the public interface of the gem, and can be called
 from any ActiveRecord model.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">module</span> <span class="nn">DSL</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> Calling <code>markdownize! :attribute</code> (where <code>:attribute</code> can be any database
 attribute with type <code>text</code>) will treat this field as Markdown.
 You can pass an <code>options</code> hash for CodeRay. An example option would be:</p>

<ul>
<li> <code>:line_numbers =&gt; :table</code> (or <code>:inline</code>)</li>
</ul>


<p> You can check other available options in CodeRay&rsquo;s documentation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">markdownize!</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> Check that both <code>:attribute</code> and <code>:rendered_attribute</code> columns exist.
 If they don&rsquo;t, it raises an error indicating that the user should generate
 a migration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">column_names</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
               <span class="nb">self</span><span class="o">.</span><span class="n">column_names</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;rendered_</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have required attributes :</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> and :rendered_</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="se">\n</span><span class="s2">Please generate a migration to add these attributes -- both should have type :text.&quot;</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> Create a <code>before_save</code> callback which will convert plain text to
 Markdownized html every time the model is saved.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">self</span><span class="o">.</span><span class="n">before_save</span> <span class="ss">:&quot;render_</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="ss">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p> Define the converter method, which will assign the rendered html to the
 <code>:rendered_attribute</code> field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">define_method</span> <span class="ss">:&quot;render_</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="ss">&quot;</span> <span class="k">do</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:&quot;rendered_</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="ss">=&quot;</span><span class="p">,</span> <span class="no">Markdownizer</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="no">Markdownizer</span><span class="o">.</span><span class="n">coderay</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">attribute</span><span class="p">),</span> <span class="n">options</span><span class="p">)))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p> Finally, make our DSL available to any class inheriting from ActiveRecord::Base.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:extend</span><span class="p">,</span> <span class="no">Markdownizer</span><span class="o">::</span><span class="no">DSL</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p> And that&rsquo;s it!</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
